<?xml version="1.0" encoding="UTF-8"?>
<definitions xmlns="http://www.omg.org/spec/BPMN/20100524/MODEL" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xmlns:activiti="http://activiti.org/bpmn" xmlns:bpmndi="http://www.omg.org/spec/BPMN/20100524/DI" xmlns:omgdc="http://www.omg.org/spec/DD/20100524/DC" xmlns:omgdi="http://www.omg.org/spec/DD/20100524/DI" typeLanguage="http://www.w3.org/2001/XMLSchema" expressionLanguage="http://www.w3.org/1999/XPath" targetNamespace="http://www.magenta-aps.dk/oewf">
  <process id="qa-and-approval" name="Kvalitetssikring og godkendelsesopgave">
    <documentation>Place documentation for the 'qa-and-approval' process here.</documentation>
    
    
    <startEvent id="QA-Approval-Task" name="Kvalitetssikring og godkendelsesopgave" activiti:formKey="oewf:submitQAApprovalTask"></startEvent>
    
    <userTask id="qaaEditProduct" name="Rediger produkt" activiti:formKey="oewf:qaEdit">
      <extensionElements>
        <activiti:taskListener event="create" class="org.alfresco.repo.workflow.activiti.tasklistener.ScriptTaskListener">
          <activiti:field name="script">
            <activiti:string>
                if (typeof bpm_workflowDueDate != 'undefined') task.dueDate = bpm_workflowDueDate;
                if (typeof bpm_workflowPriority != 'undefined') task.priority = bpm_workflowPriority;
            </activiti:string>
          </activiti:field>
        </activiti:taskListener>
        
        <activiti:taskListener event="complete" class="org.alfresco.repo.workflow.activiti.tasklistener.ScriptTaskListener">
          <activiti:field name="script">
            <activiti:string>
		// get documents
		var bpm_package =  task.getVariable('bpm_package')
		logger.log("*********************** hvad er bpm_package ******************** " + bpm_package );
                logger.log("*********************** hvad er bpm_package.children ******************** " + bpm_package.children );

		// set metadata on all documents
		for (var x in bpm_package.children) {
		   logger.log("nodref: " + bpm_package.children[x].nodeRef);


		   if (bpm_package.children[x].properties["esdh:producent"] == null) {
		       bpm_package.children[x].properties["esdh:producent"] = new Array();
		       bpm_package.children[x].properties["esdh:producent"].push(person);
		   }	
		   else {
		       bpm_package.children[x].properties["esdh:producent"].push(person);   
		   }

		   bpm_package.children[x].save();
		}
</activiti:string>
          </activiti:field>
        </activiti:taskListener>
        
        
        
      </extensionElements>
      <potentialOwner>
          <resourceAssignmentExpression>
              <formalExpression>${oewf_editGroupAssignee.properties.authorityName}</formalExpression>
          </resourceAssignmentExpression>
      </potentialOwner>
    </userTask>
    
    <sequenceFlow id="flow1" name="" sourceRef="QA-Approval-Task" targetRef="qaaEditProduct"></sequenceFlow>
    
    
    <userTask id="qaaTask" name="Kvalitetssikring" activiti:formKey="oewf:qaaQTask">
      <extensionElements>
        <activiti:taskListener event="complete" class="org.alfresco.repo.workflow.activiti.tasklistener.ScriptTaskListener">
          <activiti:field name="script">
            <activiti:string>
                execution.setVariable('bpm_assignee', person);
                execution.setVariable('oewf_qaaQTaskOutcome', task.getVariable('oewf_qaaQTaskOutcome'));
                
                
                var t = execution.getVariable('oewf_qaaQTaskOutcome');
                if (t == 'Ja') {
                  // set metadata on all documents
                  for (var x in bpm_package.children) {
                     logger.log("nodref: " + bpm_package.children[x].nodeRef);
  
  
                     if (bpm_package.children[x].properties["esdh:kvalitetssikring"] == null) {
                         bpm_package.children[x].properties["esdh:kvalitetssikring"] = new Array();
                         bpm_package.children[x].properties["esdh:kvalitetssikring"].push(person);
                     }	
                     else {
                         bpm_package.children[x].properties["esdh:kvalitetssikring"].push(person);   
                     }
  
                     bpm_package.children[x].save();
                  }
                }
                
                
            </activiti:string>
          </activiti:field>
        </activiti:taskListener>        
      </extensionElements>
      <potentialOwner>
        <resourceAssignmentExpression>
          <formalExpression>${oewf_qGroupAssignee.properties.authorityName}</formalExpression>
        </resourceAssignmentExpression>
      </potentialOwner>
    </userTask>
    
    
    <sequenceFlow id="flow2" name="" sourceRef="qaaEditProduct" targetRef="qaaTask"></sequenceFlow>
    
    <exclusiveGateway id="qaaTaskDe" name="Approved?"></exclusiveGateway>
    
    <sequenceFlow id="flow3" name="" sourceRef="qaaTask" targetRef="qaaTaskDe"></sequenceFlow>
    
    <sequenceFlow id="flow4" name="" sourceRef="qaaTaskDe" targetRef="qaaEditProduct">
        <conditionExpression xsi:type="tFormalExpression">${oewf_qaaQTaskOutcome == 'Nej'}</conditionExpression>
    </sequenceFlow>
    
    <sequenceFlow id="flow5" name="" sourceRef="qaaTaskDe" targetRef="qaaApprovalTask">
        <conditionExpression xsi:type="tFormalExpression">${oewf_qaaQTaskOutcome == 'Ja'}</conditionExpression>
    </sequenceFlow>
    
    
    <userTask id="qaaApprovalTask" name="Godkend" activiti:formKey="oewf:qaaATask">
      <extensionElements>
        <activiti:taskListener event="complete" class="org.alfresco.repo.workflow.activiti.tasklistener.ScriptTaskListener">
          <activiti:field name="script">
            <activiti:string>
                execution.setVariable('bpm_assignee', person);
                execution.setVariable('oewf_qaaATaskOutcome', task.getVariable('oewf_qaaATaskOutcome'));
                task.setVariable('oewf_isLastTask', true);
                
                
                
                var t = execution.getVariable('oewf_qaaQTaskOutcome');
                if (t == 'Ja') {
                  // set metadata on all documents
                  for (var x in bpm_package.children) {
                     logger.log("nodref: " + bpm_package.children[x].nodeRef);
  
                     if (bpm_package.children[x].properties["esdh:godkendelse"] == null) {
                         bpm_package.children[x].properties["esdh:godkendelse"] = new Array();
                         bpm_package.children[x].properties["esdh:godkendelse"].push(person);
                     }	
                     else {
                         bpm_package.children[x].properties["esdh:godkendelse"].push(person);   
                     }
  
                     bpm_package.children[x].save();
                  }
                }
                
            </activiti:string>
          </activiti:field>
        </activiti:taskListener>
      </extensionElements>

      <potentialOwner>
        <resourceAssignmentExpression>
          <formalExpression>${oewf_aGroupAssignee.properties.authorityName}</formalExpression>
        </resourceAssignmentExpression>
      </potentialOwner>

      
    </userTask>
        
    <exclusiveGateway id="qaaApprovalTaskDecision" name="Approved?"></exclusiveGateway>
    
    <sequenceFlow id="flow6" name="" sourceRef="qaaApprovalTask" targetRef="qaaApprovalTaskDecision"></sequenceFlow>
    
    <sequenceFlow id="flow7" name="" sourceRef="qaaApprovalTaskDecision" targetRef="qaaEditProduct">
      <conditionExpression xsi:type="tFormalExpression"><![CDATA[${oewf_qaaATaskOutcome == 'Nej'}]]></conditionExpression>
    </sequenceFlow>
    
    <sequenceFlow id="flow8" name="" sourceRef="qaaApprovalTaskDecision" targetRef="endevent1">
      <conditionExpression xsi:type="tFormalExpression"><![CDATA[${oewf_qaaATaskOutcome == 'Ja'}]]></conditionExpression>
    </sequenceFlow>
    
    <endEvent id="endevent1" name="End"></endEvent>
    
  </process>
  
  
  <bpmndi:BPMNDiagram id="BPMNDiagram_qa-and-approval">
    <bpmndi:BPMNPlane bpmnElement="qa-and-approval" id="BPMNPlane_qa-and-approval">
      <bpmndi:BPMNShape bpmnElement="QA-Approval-Task" id="BPMNShape_QA-Approval-Task">
        <omgdc:Bounds height="35" width="35" x="120" y="290"></omgdc:Bounds>
      </bpmndi:BPMNShape>
      <bpmndi:BPMNShape bpmnElement="qaaEditProduct" id="BPMNShape_qaaEditProduct">
        <omgdc:Bounds height="55" width="105" x="200" y="280"></omgdc:Bounds>
      </bpmndi:BPMNShape>
      <bpmndi:BPMNShape bpmnElement="qaaTask" id="BPMNShape_qaaTask">
        <omgdc:Bounds height="55" width="105" x="360" y="280"></omgdc:Bounds>
      </bpmndi:BPMNShape>
      <bpmndi:BPMNShape bpmnElement="qaaTaskDe" id="BPMNShape_qaaTaskDe">
        <omgdc:Bounds height="40" width="40" x="520" y="287"></omgdc:Bounds>
      </bpmndi:BPMNShape>
      <bpmndi:BPMNShape bpmnElement="qaaApprovalTask" id="BPMNShape_qaaApprovalTask">
        <omgdc:Bounds height="55" width="105" x="488" y="353"></omgdc:Bounds>
      </bpmndi:BPMNShape>
      <bpmndi:BPMNShape bpmnElement="qaaApprovalTaskDecision" id="BPMNShape_qaaApprovalTaskDecision">
        <omgdc:Bounds height="40" width="40" x="640" y="360"></omgdc:Bounds>
      </bpmndi:BPMNShape>
      <bpmndi:BPMNShape bpmnElement="endevent1" id="BPMNShape_endevent1">
        <omgdc:Bounds height="35" width="35" x="720" y="319"></omgdc:Bounds>
      </bpmndi:BPMNShape>
      <bpmndi:BPMNEdge bpmnElement="flow1" id="BPMNEdge_flow1">
        <omgdi:waypoint x="155" y="307"></omgdi:waypoint>
        <omgdi:waypoint x="200" y="307"></omgdi:waypoint>
      </bpmndi:BPMNEdge>
      <bpmndi:BPMNEdge bpmnElement="flow2" id="BPMNEdge_flow2">
        <omgdi:waypoint x="305" y="307"></omgdi:waypoint>
        <omgdi:waypoint x="360" y="307"></omgdi:waypoint>
      </bpmndi:BPMNEdge>
      <bpmndi:BPMNEdge bpmnElement="flow3" id="BPMNEdge_flow3">
        <omgdi:waypoint x="465" y="307"></omgdi:waypoint>
        <omgdi:waypoint x="520" y="307"></omgdi:waypoint>
      </bpmndi:BPMNEdge>
      <bpmndi:BPMNEdge bpmnElement="flow4" id="BPMNEdge_flow4">
        <omgdi:waypoint x="540" y="287"></omgdi:waypoint>
        <omgdi:waypoint x="540" y="235"></omgdi:waypoint>
        <omgdi:waypoint x="252" y="235"></omgdi:waypoint>
        <omgdi:waypoint x="252" y="280"></omgdi:waypoint>
      </bpmndi:BPMNEdge>
      <bpmndi:BPMNEdge bpmnElement="flow5" id="BPMNEdge_flow5">
        <omgdi:waypoint x="540" y="327"></omgdi:waypoint>
        <omgdi:waypoint x="540" y="353"></omgdi:waypoint>
      </bpmndi:BPMNEdge>
      <bpmndi:BPMNEdge bpmnElement="flow6" id="BPMNEdge_flow6">
        <omgdi:waypoint x="593" y="380"></omgdi:waypoint>
        <omgdi:waypoint x="640" y="380"></omgdi:waypoint>
      </bpmndi:BPMNEdge>
      <bpmndi:BPMNEdge bpmnElement="flow7" id="BPMNEdge_flow7">
        <omgdi:waypoint x="660" y="400"></omgdi:waypoint>
        <omgdi:waypoint x="660" y="464"></omgdi:waypoint>
        <omgdi:waypoint x="252" y="464"></omgdi:waypoint>
        <omgdi:waypoint x="252" y="335"></omgdi:waypoint>
      </bpmndi:BPMNEdge>
      <bpmndi:BPMNEdge bpmnElement="flow8" id="BPMNEdge_flow8">
        <omgdi:waypoint x="660" y="360"></omgdi:waypoint>
        <omgdi:waypoint x="660" y="336"></omgdi:waypoint>
        <omgdi:waypoint x="720" y="336"></omgdi:waypoint>
      </bpmndi:BPMNEdge>
    </bpmndi:BPMNPlane>
  </bpmndi:BPMNDiagram>
</definitions>